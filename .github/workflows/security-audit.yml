name: ğŸ›¡ï¸ Security Audit (OSV + Postinstall Block)

on:
  workflow_call:

jobs:
  security-audit:
    name: ğŸ” Analisar dependÃªncias e bloquear postinstall (auto-fixo)
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ§© Checkout do cÃ³digo (com submÃ³dulos)
        uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 0

      - name: ğŸ§° Configurar Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: ğŸ“ Debug de caminhos e lockfiles
        shell: bash
        run: |
          set -euo pipefail
          echo "GITHUB_WORKSPACE: ${GITHUB_WORKSPACE}"
          echo "PWD: $(pwd)"
          echo "ConteÃºdo raiz:"
          ls -lah
          echo "ConteÃºdo de src/ (se existir):"
          ls -lah src || true
          echo "ğŸ” Procurando lockfiles suportados (npm/yarn)..."
          find "${GITHUB_WORKSPACE}" -type f \( -name package-lock.json -o -name npm-shrinkwrap.json -o -name yarn.lock \) \
            | sort | tee /tmp/lockfiles.txt || true
          echo "ğŸ” Procurando manifests (package.json) para fallback por SBOM..."
          find "${GITHUB_WORKSPACE}" -type f -name package.json || true

      - name: ğŸš« Bloquear scripts pÃ³s-instalaÃ§Ã£o onde houver lockfile
        if: hashFiles('**/package-lock.json','**/npm-shrinkwrap.json','**/yarn.lock') != ''
        shell: bash
        run: |
          set -euo pipefail
          echo "ğŸ“œ Lockfiles encontrados:"
          cat /tmp/lockfiles.txt
          while read -r LOCK; do
            [[ -z "$LOCK" ]] && continue
            DIR="$(dirname "$LOCK")"
            echo "ğŸ“¦ Instalando (sem scripts) em: $DIR"
            if [[ "$LOCK" == *yarn.lock ]]; then
              ( cd "$DIR" && yarn install --ignore-scripts --frozen-lockfile || yarn install --ignore-scripts )
            else
              ( cd "$DIR" && export npm_config_ignore_scripts=true && npm ci --ignore-scripts )
            fi
          done < /tmp/lockfiles.txt

      - name: ğŸ” Instalar OSV-Scanner (user-local)
        run: |
          mkdir -p "$HOME/bin"
          curl -sSfL https://github.com/google/osv-scanner/releases/latest/download/osv-scanner_linux_amd64 \
            -o "$HOME/bin/osv-scanner"
          chmod +x "$HOME/bin/osv-scanner"
          echo "$HOME/bin" >> "$GITHUB_PATH"

      - name: ğŸ§ª Executar varredura com OSV (lockfiles absolutos)
        if: hashFiles('**/package-lock.json','**/npm-shrinkwrap.json','**/yarn.lock') != ''
        shell: bash
        run: |
          set -euo pipefail
          mapfile -t LOCKS < /tmp/lockfiles.txt
          ARGS=()
          for LOCK in "${LOCKS[@]}"; do
            [[ -f "$LOCK" ]] && ARGS+=( "--lockfile=$LOCK" )
          done
          echo "â–¶ï¸ Comando: osv-scanner ${ARGS[*]} --format=json > osv-report.json"
          osv-scanner "${ARGS[@]}" --format=json > osv-report.json || true
          echo "âœ… Scan por lockfile concluÃ­do."

      - name: âš ï¸ Falhar se houver vulnerabilidades CRÃTICAS
        shell: bash
        run: |
          set -euo pipefail
          test -f osv-report.json || { echo "RelatÃ³rio nÃ£o encontrado."; exit 1; }
          if grep -q '"severity": "CRITICAL"' osv-report.json; then
            echo "ğŸš¨ Vulnerabilidade CRÃTICA detectada! Corrija antes de prosseguir."
            exit 1
          fi
          echo "âœ… Nenhuma vulnerabilidade CRÃTICA encontrada."