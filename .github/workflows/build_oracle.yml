name: Debug SSH, Testes e Deploy

on:
  workflow_dispatch:   # dispara manualmente
  push:
    branches: ["main"]

jobs:
  debug-ssh:
    name: 🕵️ Testando conexão SSH
    runs-on: ubuntu-latest

    steps:
      - name: ⏳ Testando conexão
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.HOST_ORACLE }}
          username: ubuntu
          key: ${{ secrets.SSH_KEY_ORACLE }}
          port: 22
          script: |
            echo "✅ Consegui conectar no servidor!"

  test-cypress:
    name: 🧪 Testes E2E com Cypress
    runs-on: ubuntu-latest
    needs: debug-ssh

    steps:
      - name: 📥 Checkout do repositório
        uses: actions/checkout@v3

      - name: ⚡ Instalar dependências
        run: npm install

      - name: 🧪 Rodar Cypress
        uses: cypress-io/github-action@v6
        with:
          # record: true
          spec: "cypress/e2e/**/*.cy.js"
        env:
          # Mapeia as secrets para variáveis de ambiente
          CYPRESS_PROJECT_ID: ${{ secrets.CYPRESS_PROJECT_ID }}

  deploy:
    name: 🚀 Deploy no Oracle
    runs-on: ubuntu-latest
    needs: test-cypress

    steps:
      - name: 📂 Deploy via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.HOST_ORACLE }}
          username: ubuntu
          key: ${{ secrets.SSH_KEY_ORACLE }}
          port: 22
          script: |
            cd ~/inicial-site-exemplo
            git pull origin main
            sudo systemctl restart nginx.service