name: Debug SSH, Testes e Deploy

on:
  workflow_dispatch:   # dispara manualmente
  push:
    branches: ["main"]

jobs:
  debug-ssh:
    name: ğŸ•µï¸ Testando conexÃ£o SSH
    runs-on: ubuntu-latest

    steps:
      - name: â³ Testando conexÃ£o
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.HOST_ORACLE }}
          username: ubuntu
          key: ${{ secrets.SSH_KEY_ORACLE }}
          port: 22
          script: |
            echo "âœ… Consegui conectar no servidor!"

  test-cypress:
    name: ğŸ§ª Testes E2E com Cypress
    runs-on: ubuntu-latest
    needs: debug-ssh

    steps:
      - name: ğŸ“¥ Checkout do repositÃ³rio
        uses: actions/checkout@v3

      - name: âš¡ Instalar dependÃªncias
        run: npm install

      - name: ğŸ§ª Rodar Cypress
        uses: cypress-io/github-action@v6
        with:
          # record: true
          spec: "cypress/e2e/**/*.cy.js"
        env:
          # Mapeia as secrets para variÃ¡veis de ambiente
          CYPRESS_PROJECT_ID: ${{ secrets.CYPRESS_PROJECT_ID }}

  deploy:
    name: ğŸš€ Deploy no Oracle
    runs-on: ubuntu-latest
    needs: test-cypress

    steps:
      - name: ğŸ“‚ Deploy via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.HOST_ORACLE }}
          username: ubuntu
          key: ${{ secrets.SSH_KEY_ORACLE }}
          port: 22
          script: |
            cd ~/inicial-site-exemplo
            git pull origin main
            sudo systemctl restart nginx.service