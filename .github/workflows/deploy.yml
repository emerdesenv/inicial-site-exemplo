name: üöÄ Deploy Produ√ß√£o (TAG)

on:
  push:
    tags:
      - "v*"

jobs:
  verificar-variaveis:
    name: üîí Vari√°veis de Ambiente
    runs-on: ubuntu-latest
    steps:
      - name: üîç Validando vari√°veis
        run: |
          test -n "${{ secrets.HG_SSH_HOST }}" && \
          test -n "${{ secrets.HG_SSH_USER }}" && \
          test -n "${{ secrets.HG_SSH_KEY }}" || \
          (echo "‚ùå Vari√°veis de ambiente n√£o configuradas" && exit 1)

  deploy:
    name: üöÄ Deploy HostGator (TAG)
    runs-on: ubuntu-latest
    needs: verificar-variaveis

    steps:
      - name: Deploy da TAG no servidor
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.HG_SSH_HOST }}
          username: ${{ secrets.HG_SSH_USER }}
          key: ${{ secrets.HG_SSH_KEY }}
          passphrase: ${{ secrets.HG_SSH_PASSPHRASE }}
          script: |
            set -Eeuo pipefail

            REPO_DIR="/home4/hg6ce559/public_html/momentodev.com/inicial-site-exemplo"
            TAG="${{ github.ref_name }}"   # quando rodar por tag v*

            echo ">> Deploy da TAG: $TAG"
            echo ">> Diret√≥rio: $REPO_DIR"

            # ‚úÖ valida√ß√£o robusta (funciona se .git for pasta OU arquivo)
            if ! git -C "$REPO_DIR" rev-parse --is-inside-work-tree >/dev/null 2>&1; then
              echo "ERRO: Git n√£o reconheceu um reposit√≥rio em $REPO_DIR"
              echo "DEBUG: listagem do diret√≥rio:"
              ls -la "$REPO_DIR" || true
              echo "DEBUG: .git:"
              ls -la "$REPO_DIR/.git" || true
              exit 2
            fi

            # ‚úÖ importante: buscar tags tamb√©m
            git -C "$REPO_DIR" fetch --all --tags --prune

            # garante que a tag existe localmente depois do fetch
            if ! git -C "$REPO_DIR" show-ref --verify --quiet "refs/tags/$TAG"; then
              echo "ERRO: TAG '$TAG' n√£o encontrada no reposit√≥rio local."
              echo "Dica: confirme que voc√™ deu push da tag no GitHub."
              exit 3
            fi

            # checkout na tag (produ√ß√£o fica travada na vers√£o)
            git -C "$REPO_DIR" checkout -f "$TAG"

            # permiss√µes recomendadas
            find "$REPO_DIR" -type d -exec chmod 755 {} \;
            find "$REPO_DIR" -type f -exec chmod 644 {} \;

            echo ">> OK"

  notificacao:
    name: üì© Notifica√ß√£o Discord
    runs-on: ubuntu-latest
    needs: deploy
    steps:
      - name: Enviar notifica√ß√£o
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
        run: |
          curl -X POST -H "Content-Type: application/json" \
          -d '{
            "username": "GitHub Actions",
            "content": "‚úÖ **Deploy em Produ√ß√£o**\nüè∑Ô∏è **TAG**: `${{ github.ref_name }}`\nüë§ **Usu√°rio**: ${{ github.actor }}"
          }' \
          $DISCORD_WEBHOOK
