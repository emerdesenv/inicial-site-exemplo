name: Deploy HostGator por TAG

on:
  push:
    tags:
      - "v*"

jobs:
  verificar-variaveis:
    name: ðŸ”’ VariÃ¡veis de Ambiente
    runs-on: ubuntu-latest
    steps:
      - name: ðŸ” Validando variÃ¡veis de Ambiente
        run: |
          test -n "${{ secrets.HG_SSH_HOST }}" && \
          test -n "${{ secrets.HG_SSH_USER }}" && \
          test -n "${{ secrets.HG_SSH_KEY }}" || \
          (echo "âŒ VariÃ¡veis de ambiente nÃ£o configuradas" && exit 1)

  deploy:
    name: ðŸš€ Deploy HostGator (TAG via SSH)
    runs-on: ubuntu-latest
    needs: [verificar-variaveis]

    steps:
      - name: Deploy da TAG no servidor
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.HG_SSH_HOST }}
          username: ${{ secrets.HG_SSH_USER }}
          key: ${{ secrets.HG_SSH_KEY }}
          passphrase: ${{ secrets.HG_SSH_PASSPHRASE }}
          script: |
            set -Eeuo pipefail

            REPO_DIR="/home4/hg6ce559/public_html/momentodev.com/inicial-site-exemplo"
            TAG="${{ github.ref_name }}"

            echo ">> Deploy da TAG: $TAG"
            echo ">> DiretÃ³rio: $REPO_DIR"

            # garante que a pasta existe
            if [ ! -e "$REPO_DIR" ]; then
              echo "ERRO: DiretÃ³rio nÃ£o existe: $REPO_DIR"
              exit 2
            fi

            # valida que Ã© repo git (independente de .git ser arquivo ou pasta)
            if ! git -C "$REPO_DIR" rev-parse --is-inside-work-tree >/dev/null 2>&1; then
              echo "ERRO: DiretÃ³rio nÃ£o Ã© um repositÃ³rio Git"
              exit 3
            fi

            # atualiza refs e tags
            git -C "$REPO_DIR" fetch --all --tags --prune

            # garante que a tag existe
            if ! git -C "$REPO_DIR" show-ref --verify --quiet "refs/tags/$TAG"; then
              echo "ERRO: TAG '$TAG' nÃ£o encontrada"
              exit 4
            fi

            # checkout da tag (produÃ§Ã£o fixa na versÃ£o)
            git -C "$REPO_DIR" checkout -f "$TAG"

            # permissÃµes
            find "$REPO_DIR" -type d -exec chmod 755 {} \;
            find "$REPO_DIR" -type f -exec chmod 644 {} \;

            echo ">> Deploy concluÃ­do com sucesso"

notificacao:
    name: ðŸ“© Envio NotificaÃ§Ã£o
    runs-on: ubuntu-latest
    needs: [verificar-variaveis, deploy]

    steps:
      - name: Enviar notificaÃ§Ã£o para Discord
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
        run: |
          curl -H "Content-Type: application/json" \
          -X POST \
          -d '{
                "username": "GitHub Actions", 
                "avatar_url": "https://github.githubassets.com/images/modules/logos_page/GitHub-Mark.png", 
                "content": "âœ… **Deploy success**\nðŸŒ± **Produto**: Site Inicial\nðŸ‘¤ **UsuÃ¡rio:** ${{ github.actor }}\nðŸ”— **RepositÃ³rio**: ${{ github.repository }}\nðŸ”€ **Branch**: ${{ github.ref }}\n"
              }' \
          $DISCORD_WEBHOOK