name: Teste e Deploy no Jelastic

on:
  push:
    tags:
      - "v*"

jobs:
  verificar-variaveis:
    name: ðŸ”’ VariÃ¡veis de Ambiente
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ” Validando variÃ¡veis de Ambiente
        run: |
          test -n "${{ secrets.HG_SSH_HOST }}" && \
          test -n "${{ secrets.HG_SSH_USER }}" && \
          test -n "${{ secrets.REPO_DIR }}" && \
          test -n "${{ secrets.HG_SSH_KEY }}" || \
          (echo "âŒ VariÃ¡veis de ambiente nÃ£o configuradas" && exit 1)

  deploy:
    name: Deploy HostGator (SSH)
    runs-on: ubuntu-latest

    steps:
      - name: git pull no servidor
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.HG_SSH_HOST }}
          username: ${{ secrets.HG_SSH_USER }}
          key: ${{ secrets.HG_SSH_KEY }}
          passphrase: ${{ secrets.HG_SSH_PASSPHRASE }}
          
          script: |
            set -Eeuo pipefail

            REPO_DIR="/home4/hg6ce559/public_html/momentodev.com/inicial-site-exemplo"

            echo ">> Atualizando $REPO_DIR"
            if [ ! -d "$REPO_DIR/.git" ]; then
              echo "ERRO: nÃ£o encontrei .git em $REPO_DIR"; exit 2
            fi
            git -C "$REPO_DIR" fetch --all --prune
            git -C "$REPO_DIR" reset --hard origin/main

            # permissÃµes recomendadas
            find "$REPO_DIR" -type d -exec chmod 755 {} \;
            find "$REPO_DIR" -type f -exec chmod 644 {} \;

            echo ">> OK"