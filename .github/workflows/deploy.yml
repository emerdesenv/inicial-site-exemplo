name: üöÄ Deploy Produ√ß√£o (TAG)

on:
  push:
    tags:
      - "v*"

jobs:
  verificar-variaveis:
    name: üîí Vari√°veis de Ambiente
    runs-on: ubuntu-latest
    steps:
      - name: üîç Validando vari√°veis
        run: |
          test -n "${{ secrets.HG_SSH_HOST }}" && \
          test -n "${{ secrets.HG_SSH_USER }}" && \
          test -n "${{ secrets.HG_SSH_KEY }}" && \
          test -n "${{ secrets.REPO_DIR }}" || \
          (echo "‚ùå Vari√°veis de ambiente n√£o configuradas" && exit 1)

  deploy:
    name: üöÄ Deploy HostGator (TAG)
    runs-on: ubuntu-latest
    needs: verificar-variaveis

    steps:
      - name: Deploy da TAG no servidor
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.HG_SSH_HOST }}
          username: ${{ secrets.HG_SSH_USER }}
          key: ${{ secrets.HG_SSH_KEY }}
          passphrase: ${{ secrets.HG_SSH_PASSPHRASE }}
          script: |
            set -Eeuo pipefail

            REPO_DIR="${{ secrets.REPO_DIR }}"
            TAG="${{ github.ref_name }}"

            echo ">> Deploy da TAG: $TAG"
            echo ">> Diret√≥rio: $REPO_DIR"

            if [ ! -d "$REPO_DIR/.git" ]; then
              echo "ERRO: reposit√≥rio inv√°lido"; exit 2
            fi

            git -C "$REPO_DIR" fetch --all --tags --prune
            git -C "$REPO_DIR" checkout -f "$TAG"

            # permiss√µes padr√£o
            find "$REPO_DIR" -type d -exec chmod 755 {} \;
            find "$REPO_DIR" -type f -exec chmod 644 {} \;

            echo ">> Deploy conclu√≠do"

  notificacao:
    name: üì© Notifica√ß√£o Discord
    runs-on: ubuntu-latest
    needs: deploy
    steps:
      - name: Enviar notifica√ß√£o
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
        run: |
          curl -X POST -H "Content-Type: application/json" \
          -d '{
            "username": "GitHub Actions",
            "content": "‚úÖ **Deploy em Produ√ß√£o**\nüè∑Ô∏è **TAG**: `${{ github.ref_name }}`\nüë§ **Usu√°rio**: ${{ github.actor }}"
          }' \
          $DISCORD_WEBHOOK
